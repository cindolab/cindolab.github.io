<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CindoLab Bookkeeping Pro</title>
    <link rel="icon" type="image/svg+xml" href="/cindo.svg" />
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/locale/id.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                    },
                    colors: {
                        indigo: {
                            950: '#0f172a', // Custom dark
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #0f172a;
            color: #f8fafc;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .glass-header {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0f172a;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        @page {
            size: 58mm auto;
            margin: 0;
        }

        @media print {
            body * {
                display: none;
            }

            #receipt-area,
            #receipt-area * {
                display: block;
            }

            #receipt-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 58mm;
                color: black;
                background: white;
                padding: 10px;
            }

            #receipt-items div {
                display: flex !important;
                justify-content: space-between;
            }
        }
    </style>
</head>

<body class="antialiased min-h-screen flex flex-col md:flex-row">

    <!-- Mobile Nav -->
    <div class="md:hidden glass-header p-4 flex justify-between items-center sticky top-0 z-50">
        <h1 class="text-xl font-bold bg-gradient-to-r from-indigo-400 to-cyan-400 bg-clip-text text-transparent">
            CindoLab POS</h1>
        <button onclick="document.getElementById('mobile-menu').classList.toggle('hidden')" class="text-slate-300">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
            </svg>
        </button>
    </div>
    <div id="mobile-menu" class="hidden md:hidden fixed inset-0 z-40 bg-slate-900/95 p-4 pt-20">
        <nav class="space-y-4 text-center">
            <a href="#" onclick="showSection('dashboard'); toggleMobileMenu()"
                class="block text-lg font-medium text-slate-300 hover:text-white">Dashboard</a>
            <a href="#" onclick="showSection('kasir'); toggleMobileMenu()"
                class="block text-lg font-medium text-slate-300 hover:text-white">Kasir</a>
            <a href="#" onclick="showSection('stok'); toggleMobileMenu()"
                class="block text-lg font-medium text-slate-300 hover:text-white">Stok Barang</a>
            <a href="#" onclick="showSection('riwayat'); toggleMobileMenu()"
                class="block text-lg font-medium text-slate-300 hover:text-white">Riwayat</a>
        </nav>
    </div>

    <!-- Sidebar Desktop -->
    <aside class="hidden md:flex flex-col w-64 glass-panel border-r-0 border-r-slate-800 h-screen sticky top-0 p-6">
        <div class="mb-10">
            <h1 class="text-2xl font-bold bg-gradient-to-r from-indigo-400 to-cyan-400 bg-clip-text text-transparent">
                CindoLab</h1>
            <p class="text-xs text-slate-500 mt-1 uppercase tracking-widest">Bookkeeping Pro</p>
        </div>

        <nav class="space-y-2 flex-1">
            <button onclick="showSection('dashboard')"
                class="nav-btn w-full text-left px-4 py-3 rounded-xl text-slate-400 hover:bg-white/5 hover:text-white transition-all flex items-center gap-3 active-nav">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                </svg>
                Dashboard
            </button>
            <button onclick="showSection('kasir')"
                class="nav-btn w-full text-left px-4 py-3 rounded-xl text-slate-400 hover:bg-white/5 hover:text-white transition-all flex items-center gap-3">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                Kasir (POS)
            </button>
            <button onclick="showSection('stok')"
                class="nav-btn w-full text-left px-4 py-3 rounded-xl text-slate-400 hover:bg-white/5 hover:text-white transition-all flex items-center gap-3">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                </svg>
                Stok Barang
            </button>
            <button onclick="showSection('riwayat')"
                class="nav-btn w-full text-left px-4 py-3 rounded-xl text-slate-400 hover:bg-white/5 hover:text-white transition-all flex items-center gap-3">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                </svg>
                Riwayat
            </button>
            <button onclick="showSection('resep')"
                class="nav-btn w-full text-left px-4 py-3 rounded-xl text-slate-400 hover:bg-white/5 hover:text-white transition-all flex items-center gap-3">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                </svg>
                Resep Agar-Agar
            </button>
            <button onclick="showSection('pelanggan')"
                class="nav-btn w-full text-left px-4 py-3 rounded-xl text-slate-400 hover:bg-white/5 hover:text-white transition-all flex items-center gap-3">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                Pelanggan
            </button>
        </nav>

        <div class="mt-auto pt-6 border-t border-slate-700/50">
            <p class="text-[10px] text-slate-600 text-center">&copy; 2026 CindoLab Technology<br>Ver 2.1.0 (Profit)</p>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-4 md:p-8 overflow-y-auto max-w-7xl mx-auto w-full">

        <!-- SECTION: DASHBOARD -->
        <section id="dashboard" class="space-y-6 animate-fade-in">
            <header class="flex justify-between items-end mb-4">
                <div>
                    <h2 class="text-3xl font-bold text-white">Ringkasan Bisnis</h2>
                    <p class="text-slate-400">Pantau performa penjualan & keuntungan real-time.</p>
                </div>
                <div class="text-right">
                    <span class="text-xs text-slate-500 block mb-1">PROFIT HARI INI</span>
                    <span id="todayProfit" class="text-2xl font-bold text-emerald-400">Rp 0</span>
                </div>
            </header>

            <!-- Stats Grid -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Omset -->
                <div class="glass-panel p-6 rounded-2xl relative overflow-hidden group">
                    <div
                        class="absolute -right-6 -top-6 w-24 h-24 bg-indigo-500/20 rounded-full blur-2xl group-hover:bg-indigo-500/30 transition-all">
                    </div>
                    <p class="text-sm font-medium text-slate-400 mb-2">Omset Bulan Ini</p>
                    <h3 id="monthlySales" class="text-3xl font-bold text-white">Rp 0</h3>
                    <p class="text-xs text-indigo-400 mt-2 flex items-center gap-1">
                        Total Penjualan Kotor
                    </p>
                </div>
                <!-- Modal -->
                <div class="glass-panel p-6 rounded-2xl relative overflow-hidden group">
                    <div
                        class="absolute -right-6 -top-6 w-24 h-24 bg-pink-500/20 rounded-full blur-2xl group-hover:bg-pink-500/30 transition-all">
                    </div>
                    <p class="text-sm font-medium text-slate-400 mb-2">Modal Terjual</p>
                    <h3 id="monthlyCost" class="text-3xl font-bold text-white">Rp 0</h3>
                    <p class="text-xs text-rose-400 mt-2">HPP (Harga Pokok Penjualan)</p>
                </div>
                <!-- Profit -->
                <div class="glass-panel p-6 rounded-2xl relative overflow-hidden group">
                    <div
                        class="absolute -right-6 -top-6 w-24 h-24 bg-emerald-500/20 rounded-full blur-2xl group-hover:bg-emerald-500/30 transition-all">
                    </div>
                    <p class="text-sm font-medium text-slate-400 mb-2">Keuntungan Bersih</p>
                    <h3 id="monthlyProfit" class="text-3xl font-bold text-emerald-400">Rp 0</h3>
                    <p class="text-xs text-slate-500 mt-2">Omset - Modal</p>
                </div>
            </div>

            <!-- Chart Area -->
            <div class="glass-panel p-6 rounded-2xl border-t border-white/10">
                <h3 class="text-lg font-semibold text-white mb-6">Tren Penjualan & Profit (7 Hari)</h3>
                <div class="w-full h-64 md:h-80">
                    <canvas id="salesChart"></canvas>
                </div>
            </div>
        </section>

        <!-- SECTION: KASIR (POS) -->
        <section id="kasir" class="hidden space-y-6">
            <header class="mb-4">
                <h2 class="text-3xl font-bold text-white">Kasir (Point of Sales)</h2>
                <p class="text-slate-400">Mode Penjualan Cepat</p>
            </header>

            <div class="flex flex-col lg:flex-row gap-6">
                <!-- Product Selector (Left) -->
                <div class="lg:w-2/3 space-y-6">
                    <!-- Search & Products -->
                    <div class="glass-panel p-6 rounded-2xl">
                        <div class="flex gap-4 mb-6">
                            <div class="relative flex-1">
                                <svg class="absolute left-3 top-3 w-5 h-5 text-slate-500" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                                <input type="text" id="posSearch" placeholder="Cari barang..."
                                    class="w-full bg-slate-800/50 border border-slate-700 text-white rounded-xl py-2.5 pl-10 pr-4 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            </div>
                            <button onclick="openAddProductModal()"
                                class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-xl transition-colors font-medium flex items-center gap-2">
                                + Barang Baru
                            </button>
                        </div>

                        <!-- Product Grid -->
                        <div id="productGrid"
                            class="grid grid-cols-2 md:grid-cols-3 gap-4 max-h-[500px] overflow-y-auto pr-2">
                            <!-- Items will be injected here -->
                        </div>
                    </div>
                </div>

                <!-- Cart (Right) -->
                <div class="lg:w-1/3">
                    <div class="glass-panel rounded-2xl flex flex-col h-[calc(100vh-140px)] sticky top-6">
                        <div class="p-4 border-b border-slate-700">
                            <h3 class="text-lg font-bold text-white flex items-center gap-2">
                                <svg class="w-5 h-5 text-indigo-400" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                                </svg>
                                Keranjang Belanja
                            </h3>
                        </div>

                        <!-- Cart Items -->
                        <div id="cartItems" class="flex-1 overflow-y-auto p-4 space-y-3">
                            <div class="text-center text-slate-500 py-10">Keranjang masih kosong</div>
                        </div>

                        <!-- Cart Summary -->
                        <div class="p-6 bg-slate-900/50 border-t border-slate-700 mt-auto">
                            <div class="flex justify-between mb-2 text-slate-400">
                                <span>Subtotal</span>
                                <span id="cartSubtotal" class="text-white">Rp 0</span>
                            </div>
                            <div class="flex justify-between mb-6">
                                <span class="text-lg font-bold text-indigo-300">Total</span>
                                <span id="cartTotal" class="text-2xl font-bold text-white">Rp 0</span>
                            </div>
                            <button onclick="processCheckout()" id="checkoutBtn" disabled
                                class="w-full bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-500 hover:to-teal-500 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-3.5 rounded-xl shadow-lg shadow-emerald-900/20 transition-all flex justify-center items-center gap-2">
                                Bayar & Cetak Nota
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION: STOK BARANG -->
        <section id="stok" class="hidden space-y-6">
            <header class="flex justify-between items-center mb-4">
                <div>
                    <h2 class="text-3xl font-bold text-white">Manajemen Stok & Harga</h2>
                    <p class="text-slate-400">Atur stok dan harga beli untuk menghitung profit.</p>
                </div>
                <button onclick="openAddProductModal()"
                    class="bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-2.5 rounded-xl font-medium transition-colors">
                    + Tambah Stok
                </button>
            </header>

            <div class="glass-panel overflow-hidden rounded-2xl">
                <table class="w-full text-left">
                    <thead class="bg-slate-800/50 text-slate-400 uppercase text-xs">
                        <tr>
                            <th class="p-5 font-semibold">Nama Barang</th>
                            <th class="p-5 font-semibold text-right">Harga Beli (Modal)</th>
                            <th class="p-5 font-semibold text-right">Harga Jual</th>
                            <th class="p-5 font-semibold text-right">Margin</th>
                            <th class="p-5 font-semibold text-right">Stok</th>
                            <th class="p-5 font-semibold text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryTable" class="divide-y divide-slate-700/50 text-sm">
                        <!-- Inventory Rows -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- SECTION: RIWAYAT -->
        <section id="riwayat" class="hidden space-y-6">
            <header class="flex justify-between items-center mb-4">
                <div>
                    <h2 class="text-3xl font-bold text-white">Riwayat Transaksi</h2>
                    <p class="text-slate-400">Log lengkap penjualan dan profit per transaksi.</p>
                </div>
                <button onclick="exportData()"
                    class="text-indigo-400 hover:text-white text-sm font-medium border border-indigo-500/30 px-4 py-2 rounded-lg hover:bg-indigo-500/20 transition-all">
                    Download JSON
                </button>
            </header>

            <div class="glass-panel overflow-hidden rounded-2xl">
                <table class="w-full text-left">
                    <thead class="bg-slate-800/50 text-slate-400 uppercase text-xs">
                        <tr>
                            <th class="p-5 font-semibold">ID / Tanggal</th>
                            <th class="p-5 font-semibold">Detail Barang</th>
                            <th class="p-5 font-semibold text-right">Omset</th>
                            <th class="p-5 font-semibold text-right">Profit</th>
                            <th class="p-5 font-semibold text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="historyTable" class="divide-y divide-slate-700/50 text-sm">
                        <!-- History Rows -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- SECTION: RESEP -->
        <section id="resep" class="hidden space-y-6">
            <header class="mb-4">
                <h2 class="text-3xl font-bold text-white">Resep Inspirasi</h2>
                <p class="text-slate-400">Aneka kreasi lezat berbahan dasar agar-agar.</p>
            </header>

            <div id="recipeGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Recipe Cards will be injected here -->
            </div>
        </section>

        <!-- SECTION: PELANGGAN -->
        <section id="pelanggan" class="hidden space-y-6">
            <header class="flex justify-between items-end mb-4">
                <div>
                    <h2 class="text-3xl font-bold text-white">Daftar Pelanggan</h2>
                    <p class="text-slate-400">Kelola data pelanggan dan kontak.</p>
                </div>
                <button onclick="openCustomerModal()"
                    class="bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-3 rounded-xl transition-colors font-bold shadow-lg shadow-indigo-500/20 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    Tambah Pelanggan
                </button>
            </header>

            <div class="glass-panel overflow-hidden rounded-2xl">
                <table class="w-full text-left">
                    <thead class="bg-slate-800/50 text-slate-400 uppercase text-xs">
                        <tr>
                            <th class="p-5 font-semibold">Nama Pelanggan</th>
                            <th class="p-5 font-semibold">Alamat (Toko/Rumah)</th>
                            <th class="p-5 font-semibold">Kontak</th>
                            <th class="p-5 font-semibold text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="customerTable" class="divide-y divide-slate-700/50 text-sm">
                        <!-- Customer Rows -->
                    </tbody>
                </table>
            </div>
        </section>

    </main>

    <!-- MODAL: ADD CUSTOMER -->
    <div id="customerModal"
        class="fixed inset-0 z-[60] bg-black/80 hidden backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-slate-900 border border-slate-700 rounded-2xl max-w-md w-full p-6 shadow-2xl scale-95 opacity-0 transition-all duration-300 transform"
            id="customerModalContent">
            <h3 class="text-xl font-bold text-white mb-6">Data Pelanggan</h3>
            <form id="customerForm" class="space-y-4">
                <input type="hidden" id="custId">
                <div>
                    <label class="block text-xs uppercase text-slate-500 font-bold mb-2">Nama Lengkap</label>
                    <input type="text" id="custName" required
                        class="w-full bg-slate-800 border border-slate-700 text-white rounded-xl p-3 focus:ring-2 focus:ring-indigo-500 focus:outline-none"
                        placeholder="Contoh: Budi Santoso">
                </div>
                <div>
                    <label class="block text-xs uppercase text-slate-500 font-bold mb-2">Alamat </label>
                    <textarea id="custAddress" required rows="2"
                        class="w-full bg-slate-800 border border-slate-700 text-white rounded-xl p-3 focus:ring-2 focus:ring-indigo-500 focus:outline-none"
                        placeholder="Alamat Toko / Rumah"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs uppercase text-slate-500 font-bold mb-2">WhatsApp</label>
                        <input type="text" id="custWA"
                            class="w-full bg-slate-800 border border-slate-700 text-white rounded-xl p-3 focus:ring-2 focus:ring-indigo-500 focus:outline-none"
                            placeholder="628xxx">
                    </div>
                    <div>
                        <label class="block text-xs uppercase text-slate-500 font-bold mb-2">Telegram</label>
                        <input type="text" id="custTele"
                            class="w-full bg-slate-800 border border-slate-700 text-white rounded-xl p-3 focus:ring-2 focus:ring-indigo-500 focus:outline-none"
                            placeholder="Username / No.HP">
                    </div>
                </div>
                <div class="pt-4 flex gap-3">
                    <button type="button" onclick="closeCustomerModal()"
                        class="flex-1 bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-xl transition-colors font-bold">Batal</button>
                    <button type="submit"
                        class="flex-1 bg-gradient-to-r from-indigo-600 to-cyan-600 hover:from-indigo-500 hover:to-cyan-500 text-white py-3 rounded-xl transition-all font-bold shadow-lg shadow-indigo-500/25">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: RECIPE DETAIL -->
    <div id="recipeModal"
        class="fixed inset-0 z-[60] bg-black/80 hidden backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-slate-900 border border-slate-700 rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto p-0 shadow-2xl scale-95 opacity-0 transition-all duration-300 transform"
            id="recipeModalContent">
            <div class="relative h-48 bg-indigo-900 overflow-hidden">
                <div class="absolute inset-0 bg-gradient-to-t from-slate-900 to-transparent"></div>
                <!-- Abstract food pattern using CSS -->
                <div class="absolute inset-0 opacity-30 pattern-dots"></div>
                <button onclick="closeRecipeModal()"
                    class="absolute top-4 right-4 bg-black/50 hover:bg-black/70 text-white rounded-full p-2 transition-colors">
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
                <div class="absolute bottom-4 left-6">
                    <span
                        class="bg-indigo-500 text-white text-xs font-bold px-2 py-1 rounded-md mb-2 inline-block">FAVORIT</span>
                    <h3 id="recipeTitle" class="text-2xl font-bold text-white">Judul Resep</h3>
                </div>
            </div>
            <div class="p-6 space-y-6">
                <div>
                    <h4 class="text-lg font-bold text-indigo-400 mb-3 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                        </svg>
                        Bahan-bahan
                    </h4>
                    <ul id="recipeIngredients" class="list-disc list-inside text-slate-300 space-y-1 ml-1"></ul>
                </div>
                <div>
                    <h4 class="text-lg font-bold text-indigo-400 mb-3 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                        </svg>
                        Cara Membuat
                    </h4>
                    <ol id="recipeSteps" class="list-decimal list-inside text-slate-300 space-y-2 ml-1"></ol>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: ADD PRODUCT/STOCK -->
    <div id="productModal"
        class="fixed inset-0 z-[60] bg-black/80 hidden backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-slate-900 border border-slate-700 rounded-2xl max-w-md w-full p-6 shadow-2xl scale-95 opacity-0 transition-all duration-300 transform"
            id="productModalContent">
            <h3 class="text-xl font-bold text-white mb-6">Kelola Barang</h3>
            <form id="productForm" class="space-y-4">
                <input type="hidden" id="prodId">
                <div>
                    <label class="block text-xs uppercase text-slate-500 font-bold mb-2">Nama Barang</label>
                    <input type="text" id="prodName" required
                        class="w-full bg-slate-800 border border-slate-700 text-white rounded-xl p-3 focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs uppercase text-slate-500 font-bold mb-2">Harga Beli (Modal)</label>
                        <input type="number" id="prodBuyPrice" required min="0"
                            class="w-full bg-slate-800 border border-slate-700 text-white rounded-xl p-3 focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-xs uppercase text-slate-500 font-bold mb-2">Harga Jual</label>
                        <input type="number" id="prodPrice" required min="0"
                            class="w-full bg-slate-800 border border-slate-700 text-white rounded-xl p-3 focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                    </div>
                </div>
                <div>
                    <label class="block text-xs uppercase text-slate-500 font-bold mb-2">Stok Sekarang</label>
                    <input type="number" id="prodStock" required min="0"
                        class="w-full bg-slate-800 border border-slate-700 text-white rounded-xl p-3 focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                </div>
                <div class="pt-4 flex gap-3">
                    <button type="button" onclick="closeProductModal()"
                        class="flex-1 bg-slate-800 hover:bg-slate-700 text-slate-300 py-3 rounded-xl font-medium transition-colors">Batal</button>
                    <button type="submit"
                        class="flex-1 bg-indigo-600 hover:bg-indigo-500 text-white py-3 rounded-xl font-bold transition-colors">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Hidden Receipt Area -->
    <div id="receipt-area" class="hidden text-black text-xs font-mono">
        <div style="text-align:center; margin-bottom: 10px;">
            <h2 style="font-size: 14px; font-weight: bold; margin:0;">CINDOLAB</h2>
            <p style="margin:0;">Agar-Agar Bubuk Premium</p>
            <p style="margin:0;" id="receipt-date"></p>
        </div>
        <hr style="border-top: 1px dashed black; margin: 5px 0;">
        <div id="receipt-items"></div>
        <hr style="border-top: 1px dashed black; margin: 5px 0;">
        <div style="display:flex; justify-content:space-between; font-weight:bold;">
            <span>TOTAL</span>
            <span id="receipt-total"></span>
        </div>
        <p style="text-align:center; margin-top: 15px;">Terima Kasih!</p>
    </div>

    <script>
        // --- DATA & STATE ---
        // Initialize Default Inventory with BuyPrice
        const defaultInventory = [
            { id: 1, name: 'Agar-agar Bubuk Plain', buyPrice: 3500, price: 5000, stock: 100 },
            { id: 2, name: 'Agar-agar Rasa Coklat', buyPrice: 4000, price: 6000, stock: 50 },
            { id: 3, name: 'Agar-agar Rasa Strawberry', buyPrice: 4000, price: 6000, stock: 45 },
            { id: 4, name: 'Bubuk Jelly Mix', buyPrice: 5000, price: 7500, stock: 30 }
        ];

        let inventory = JSON.parse(localStorage.getItem('cindolab_inventory')) || defaultInventory;
        // Migrate old inventory if missing buyPrice
        inventory = inventory.map(i => ({ ...i, buyPrice: i.buyPrice || (i.price * 0.7) }));

        let transactions = JSON.parse(localStorage.getItem('cindolab_transactions')) || [];
        let customers = JSON.parse(localStorage.getItem('cindolab_customers')) || [];
        let cart = [];

        // --- RECIPES ---
        const recipes = [
            {
                id: 1,
                title: 'Puding Coklat Lava',
                desc: 'Puding coklat lembut dengan lelehan vla di tengahnya.',
                color: 'from-amber-700 to-orange-900',
                ingredients: [
                    '1 bungkus Agar-agar Bubuk Coklat',
                    '700 ml Susu Cair Coklat',
                    '150 gr Gula Pasir',
                    '50 gr Dark Chocolate (lelehkan)',
                    'Vla Vanila secukupnya'
                ],
                steps: [
                    'Campurkan agar-agar, gula, dan susu cair dalam panci.',
                    'Masak dengan api sedang sambil diaduk terus hingga mendidih.',
                    'Masukkan dark chocolate leleh, aduk rata hingga larut.',
                    'Tuang ke dalam cetakan, biarkan setengah dingin.',
                    'Sajikan dengan siraman vla vanila di atasnya.'
                ]
            },
            {
                id: 2,
                title: 'Agar-Agar Santan Gula Merah',
                desc: 'Cita rasa tradisional yang manis dan gurih, favorit keluarga.',
                color: 'from-orange-500 to-red-700',
                ingredients: [
                    '1 bungkus Agar-agar Bubuk Putih',
                    '200 gr Gula Merah (sisir)',
                    '800 ml Santan Kekentalan Sedang',
                    '1 lembar Daun Pandan',
                    'Sejumput Garam'
                ],
                steps: [
                    'Rebus gula merah dengan sedikit air hingga larut, saring.',
                    'Campurkan air gula merah, santan, agar-agar, dan garam.',
                    'Masak sambil diaduk agar santan tidak pecah.',
                    'Masukkan daun pandan simpul.',
                    'Setelah mendidih, angkat dan tuang ke cetakan. Biarkan mengeras (akan terbentuk lapisan santan alami).'
                ]
            },
            {
                id: 3,
                title: 'Puding Buah Kaca',
                desc: 'Tampilan cantik transparan dengan potongan buah segar.',
                color: 'from-pink-500 to-rose-600',
                ingredients: [
                    '1 bungkus Agar-agar Bubuk Putih/Plain',
                    '600 ml Air',
                    '120 gr Gula Pasir',
                    'Buah Potong (Strawberry, Kiwi, Jeruk, Anggur)',
                    '1 sdt Biji Selasih (rendam air hangat)'
                ],
                steps: [
                    'Tata potongan buah segar di dasar cetakan puding.',
                    'Masak agar-agar, air, dan gula hingga mendidih.',
                    'Matikan api, tunggu uap panas hilang (suam-suam kuku).',
                    'Tuang perlahan ke atas buah agar buah tidak mengapung berantakan.',
                    'Dinginkan di kulkas hingga set. Potong dan sajikan dingin.'
                ]
            },
            {
                id: 4,
                title: 'Es Agar-Agar Serut',
                desc: 'Minuman segar dengan tekstur agar yang unik, cocok untuk cuaca panas.',
                color: 'from-cyan-500 to-blue-600',
                ingredients: [
                    '1 bungkus Agar-agar Bubuk Hijau/Merah',
                    '700 ml Air',
                    '100 gr Gula Pasir',
                    'Sirup Cocopandan',
                    'Es Batu & Susu Kental Manis'
                ],
                steps: [
                    'Masak agar-agar seperti biasa hingga mendidih, biarkan mengeras di wadah datar.',
                    'Setelah keras, parut kasar memanjang menggunakan parutan keju.',
                    'Siapkan gelas, masukkan es batu, agar-agar serut, dan sirup.',
                    'Tambahkan air dan susu kental manis sesuai selera.',
                    'Aduk rata dan sajikan segera.'
                ]
            }
        ];

        function renderRecipes() {
            const grid = document.getElementById('recipeGrid');
            grid.innerHTML = '';
            recipes.forEach(r => {
                const card = document.createElement('div');
                card.className = 'glass-panel overflow-hidden rounded-2xl group cursor-pointer hover:border-indigo-500/50 transition-all';
                card.onclick = () => openRecipeModal(r);
                card.innerHTML = `
                    <div class="h-32 bg-gradient-to-br ${r.color} relative">
                         <div class="absolute inset-0 bg-black/20 group-hover:bg-transparent transition-all"></div>
                         <div class="absolute bottom-4 left-4">
                            <h3 class="text-lg font-bold text-white shadow-black drop-shadow-md">${r.title}</h3>
                         </div>
                    </div>
                    <div class="p-4">
                        <p class="text-slate-400 text-sm line-clamp-2">${r.desc}</p>
                        <div class="mt-4 flex items-center text-indigo-400 text-xs font-bold gap-1 group-hover:gap-2 transition-all">
                            LIHAT RESEP
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" /></svg>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function openRecipeModal(recipe) {
            document.getElementById('recipeTitle').innerText = recipe.title;

            const ingList = document.getElementById('recipeIngredients');
            ingList.innerHTML = recipe.ingredients.map(i => `<li>${i}</li>`).join('');

            const stepList = document.getElementById('recipeSteps');
            stepList.innerHTML = recipe.steps.map(s => `<li>${s}</li>`).join('');

            document.getElementById('recipeModal').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('recipeModalContent').classList.remove('scale-95', 'opacity-0');
                document.getElementById('recipeModalContent').classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeRecipeModal() {
            document.getElementById('recipeModalContent').classList.add('scale-95', 'opacity-0');
            document.getElementById('recipeModalContent').classList.remove('scale-100', 'opacity-100');
            setTimeout(() => {
                document.getElementById('recipeModal').classList.add('hidden');
            }, 300);
        }

        // --- CHART INSTANCE ---
        let salesChart = null;

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            dayjs.locale('id');
            renderInventory();
            renderProductGrid();
            renderHistory();
            renderRecipes();
            renderCustomers();

            // Initial Section
            showSection('dashboard');
        });

        // --- NAVIGATION ---
        function showSection(id) {
            document.querySelectorAll('main > section').forEach(el => el.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');

            // Update Active Nav State
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('bg-white/10', 'text-white'));
            const activeBtn = document.querySelector(`button[onclick="showSection('${id}')"]`);
            if (activeBtn) activeBtn.classList.add('bg-white/10', 'text-white');

            // Refresh data if needed
            if (id === 'dashboard') updateDashboard();
        }

        function toggleMobileMenu() {
            document.getElementById('mobile-menu').classList.toggle('hidden');
        }

        // --- POS & CART ---
        function renderProductGrid(filter = '') {
            const grid = document.getElementById('productGrid');
            grid.innerHTML = '';

            const filtered = inventory.filter(item => item.name.toLowerCase().includes(filter.toLowerCase()));

            filtered.forEach(item => {
                const el = document.createElement('div');
                el.className = 'glass-panel p-4 rounded-xl cursor-pointer hover:bg-white/5 transition-colors border border-transparent hover:border-indigo-500/50 flex flex-col items-center text-center group';
                el.innerHTML = `
                   <div class="w-10 h-10 bg-indigo-500/20 text-indigo-400 rounded-lg flex items-center justify-center mb-3 group-hover:bg-indigo-500 group-hover:text-white transition-all font-bold text-lg">
                        ${item.name.charAt(0)}
                   </div>
                   <h4 class="text-sm font-semibold text-slate-200 line-clamp-2 min-h-[40px]">${item.name}</h4>
                   <p class="text-xs text-slate-500 mt-1">Stok: ${item.stock}</p>
                   <p class="text-sm font-bold text-emerald-400 mt-2">${formatRupiah(item.price)}</p>
                `;
                el.onclick = () => addToCart(item.id);
                grid.appendChild(el);
            });
        }

        document.getElementById('posSearch').addEventListener('input', (e) => renderProductGrid(e.target.value));

        function addToCart(itemId) {
            const item = inventory.find(i => i.id === itemId);
            if (!item) return;

            if (item.stock <= 0) {
                alert('Stok habis!');
                return;
            }

            const existing = cart.find(c => c.id === itemId);
            if (existing) {
                if (existing.qty < item.stock) {
                    existing.qty++;
                } else {
                    alert('Stok tidak mencukupi untuk menambah lagi.');
                }
            } else {
                cart.push({ ...item, qty: 1 });
            }
            renderCart();
        }

        function renderCart() {
            const container = document.getElementById('cartItems');
            const subtotalEl = document.getElementById('cartSubtotal');
            const totalEl = document.getElementById('cartTotal');
            const checkoutBtn = document.getElementById('checkoutBtn');

            container.innerHTML = '';
            let total = 0;

            if (cart.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-500 py-10 flex flex-col items-center"><svg class="w-12 h-12 mb-3 text-slate-700" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" /></svg>Belum ada item</div>';
                checkoutBtn.disabled = true;
            } else {
                checkoutBtn.disabled = false;
                cart.forEach((item, index) => {
                    total += item.price * item.qty;
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center bg-slate-800/40 p-3 rounded-lg border border-slate-800 hover:border-indigo-500/30 transition-colors';
                    div.innerHTML = `
                        <div class="flex-1">
                            <h5 class="text-sm font-medium text-slate-200">${item.name}</h5>
                            <p class="text-xs text-indigo-400">${formatRupiah(item.price)} x ${item.qty}</p>
                        </div>
                        <div class="flex items-center gap-2">
                             <div class="text-sm font-bold text-white mr-2">${formatRupiah(item.price * item.qty)}</div>
                             <button onclick="removeFromCart(${index})" class="text-slate-500 hover:text-red-400">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                             </button>
                        </div>
                    `;
                    container.appendChild(div);
                });
            }

            subtotalEl.innerText = formatRupiah(total);
            totalEl.innerText = formatRupiah(total);
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            renderCart();
        }

        function processCheckout() {
            if (cart.length === 0) return;

            // Calculate total profit at moment of sale
            let totalProfit = 0;
            let totalCost = 0;

            const processedItems = cart.map(item => {
                const profitPerItem = item.price - item.buyPrice;
                totalProfit += profitPerItem * item.qty;
                totalCost += item.buyPrice * item.qty;
                return { ...item };
            });

            // 1. Create Transaction
            const transaction = {
                id: Date.now(),
                date: new Date().toISOString(),
                type: 'sell',
                items: processedItems,
                total: cart.reduce((sum, item) => sum + (item.price * item.qty), 0),
                totalCost: totalCost,
                profit: totalProfit
            };

            // 2. Reduce Stock
            cart.forEach(cartItem => {
                const inventoryItem = inventory.find(i => i.id === cartItem.id);
                if (inventoryItem) {
                    inventoryItem.stock -= cartItem.qty;
                }
            });

            // 3. Save
            transactions.unshift(transaction);
            saveData();

            // 4. Print Request
            printReceipt(transaction);

            // 5. Reset
            cart = [];
            renderCart();
            renderInventory(); // Update stock display
            renderHistory();
            updateDashboard();
            alert('Transaksi Berhasil Disimpan!');
        }

        function printReceipt(transaction) {
            const area = document.getElementById('receipt-area');
            const dateEl = document.getElementById('receipt-date');
            const itemsEl = document.getElementById('receipt-items');
            const totalEl = document.getElementById('receipt-total');

            dateEl.innerText = dayjs(transaction.date).format('DD/MM/YYYY HH:mm');
            totalEl.innerText = formatRupiah(transaction.total);

            itemsEl.innerHTML = '';
            transaction.items.forEach(item => {
                const line = document.createElement('div');
                line.style.display = 'flex';
                line.style.justifyContent = 'space-between';
                line.innerHTML = `<span>${item.name} x${item.qty}</span> <span>${formatRupiah(item.price * item.qty)}</span>`;
                itemsEl.appendChild(line);
            });

            window.print();
        }

        // --- INVENTORY MANAGEMENT ---
        function renderInventory() {
            const tbody = document.getElementById('inventoryTable');
            tbody.innerHTML = '';

            inventory.forEach(item => {
                const margin = item.price - item.buyPrice;
                const marginPercent = item.buyPrice > 0 ? ((margin / item.buyPrice) * 100).toFixed(0) + '%' : 'âˆž%';

                const tr = document.createElement('tr');
                tr.className = 'hover:bg-white/5 transition-colors';
                tr.innerHTML = `
                    <td class="p-5 font-medium text-slate-200">${item.name}</td>
                    <td class="p-5 text-right text-slate-400">${formatRupiah(item.buyPrice)}</td>
                    <td class="p-5 text-right text-white">${formatRupiah(item.price)}</td>
                    <td class="p-5 text-right text-emerald-400 text-xs font-bold">+${formatRupiah(margin)} (${marginPercent})</td>
                    <td class="p-5 text-right font-bold text-white">${item.stock}</td>
                    <td class="p-5 text-center px-2 flex justify-center gap-2">
                         <button onclick="editStock(${item.id})" class="text-slate-500 hover:text-indigo-400 transition-colors" title="Edit">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                         </button>
                         <button onclick="deleteStock(${item.id})" class="text-slate-500 hover:text-rose-400 transition-colors" title="Hapus">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                         </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            renderProductGrid(); // Also update grid
        }

        function openAddProductModal(editId = null) {
            document.getElementById('productForm').reset();
            document.getElementById('prodId').value = '';

            if (editId) {
                const item = inventory.find(i => i.id === editId);
                if (item) {
                    document.getElementById('prodId').value = item.id;
                    document.getElementById('prodName').value = item.name;
                    document.getElementById('prodBuyPrice').value = item.buyPrice;
                    document.getElementById('prodPrice').value = item.price;
                    document.getElementById('prodStock').value = item.stock;
                }
            }

            document.getElementById('productModal').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('productModalContent').classList.remove('scale-95', 'opacity-0');
                document.getElementById('productModalContent').classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function editStock(id) {
            openAddProductModal(id);
        }

        function deleteStock(id) {
            if (confirm('Yakin ingin menghapus barang ini? Stok akan hilang permanen.')) {
                const index = inventory.findIndex(i => i.id === id);
                if (index !== -1) {
                    inventory.splice(index, 1);
                    saveData();
                    renderInventory();
                }
            }
        }

        function closeProductModal() {
            document.getElementById('productModalContent').classList.add('scale-95', 'opacity-0');
            document.getElementById('productModalContent').classList.remove('scale-100', 'opacity-100');
            setTimeout(() => {
                document.getElementById('productModal').classList.add('hidden');
            }, 300);
        }

        document.getElementById('productForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('prodId').value;
            const name = document.getElementById('prodName').value;
            const buyPrice = parseInt(document.getElementById('prodBuyPrice').value);
            const price = parseInt(document.getElementById('prodPrice').value);
            const stock = parseInt(document.getElementById('prodStock').value);

            if (id) {
                // Edit existing
                const index = inventory.findIndex(i => i.id == id);
                if (index !== -1) {
                    inventory[index] = { ...inventory[index], name, buyPrice, price, stock };
                }
            } else {
                // Add new
                const newItem = {
                    id: Date.now(),
                    name,
                    buyPrice,
                    price,
                    stock
                };
                inventory.push(newItem);
            }

            saveData();
            renderInventory();
            closeProductModal();
        });

        // --- MARGIN CALCULATOR ---
        const buyPriceInput = document.getElementById('prodBuyPrice');
        const priceInput = document.getElementById('prodPrice');
        const marginPreview = document.createElement('div');
        marginPreview.id = 'marginPreview';
        marginPreview.className = 'text-xs font-bold mt-2 text-right';
        // Insert after the grid container of prices
        priceInput.parentElement.parentElement.after(marginPreview);

        function updateMarginPreview() {
            const buy = parseFloat(buyPriceInput.value) || 0;
            const sell = parseFloat(priceInput.value) || 0;
            const margin = sell - buy;
            const percent = buy > 0 ? ((margin / buy) * 100).toFixed(0) : (sell > 0 ? 'âˆž' : 0);

            if (margin > 0) {
                marginPreview.className = 'text-xs font-bold mt-2 text-right text-emerald-400';
                marginPreview.innerHTML = `Estimasi Profit: +${formatRupiah(margin)} (${percent}%)`;
            } else if (margin < 0) {
                marginPreview.className = 'text-xs font-bold mt-2 text-right text-rose-400';
                marginPreview.innerHTML = `Estimasi Rugi: ${formatRupiah(margin)} (${percent}%)`;
            } else {
                marginPreview.className = 'text-xs font-bold mt-2 text-right text-slate-500';
                marginPreview.innerHTML = `Tidak Ada Profit (0%)`;
            }
        }

        buyPriceInput.addEventListener('input', updateMarginPreview);
        priceInput.addEventListener('input', updateMarginPreview);


        // --- HISTORY ---
        function renderHistory() {
            const tbody = document.getElementById('historyTable');
            tbody.innerHTML = '';

            transactions.forEach(t => {
                let itemsHtml = t.items.map(i => `${i.name} (${i.qty})`).join(', ');
                const profit = t.profit || 0;
                // If profit not stored (legacy data), we might show 0 or estimate.

                const tr = document.createElement('tr');
                tr.className = 'hover:bg-white/5 transition-colors';
                tr.innerHTML = `
                    <td class="p-5 text-slate-400">
                        <span class="block text-white font-mono text-xs mb-1">#${t.id.toString().slice(-6)}</span>
                        ${dayjs(t.date).format('DD MMM YY HH:mm')}
                    </td>
                    <td class="p-5 text-slate-300 text-sm max-w-xs truncate">${itemsHtml}</td>
                    <td class="p-5 text-right font-bold text-white">${formatRupiah(t.total)}</td>
                    <td class="p-5 text-right font-bold text-emerald-400">+${formatRupiah(profit)}</td>
                    <td class="p-5 text-center">
                         <button onclick="deleteTransaction(${t.id})" class="text-slate-600 hover:text-red-500 transition-colors" title="Hapus">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </td>
                 `;
                tbody.appendChild(tr);
            });
        }

        function deleteTransaction(id) {
            if (confirm('Hapus transaksi ini?')) {
                transactions = transactions.filter(t => t.id !== id);
                saveData();
                renderHistory();
                updateDashboard();
            }
        }

        // --- CUSTOMERS ---
        function renderCustomers() {
            const tbody = document.getElementById('customerTable');
            tbody.innerHTML = '';

            customers.forEach(c => {
                const waLink = c.wa ? `https://wa.me/${c.wa.replace(/^0/, '62').replace(/\D/g, '')}` : '#';
                const teleLink = c.tele ? `https://t.me/${c.tele.replace('@', '')}` : '#';

                const tr = document.createElement('tr');
                tr.className = 'hover:bg-white/5 transition-colors';
                tr.innerHTML = `
                    <td class="p-5 font-medium text-slate-200">${c.name}</td>
                    <td class="p-5 text-slate-400">${c.address}</td>
                    <td class="p-5 flex gap-2">
                        ${c.wa ? `<a href="${waLink}" target="_blank" class="bg-emerald-500/20 text-emerald-400 hover:bg-emerald-500 hover:text-white p-2 rounded-lg transition-colors" title="Chat WhatsApp"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.501-.669-.51l-.57-.01c-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.095 3.2 5.076 4.487.709.306 1.263.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg></a>` : ''}
                        ${c.tele ? `<a href="${teleLink}" target="_blank" class="bg-sky-500/20 text-sky-400 hover:bg-sky-500 hover:text-white p-2 rounded-lg transition-colors" title="Chat Telegram"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg></a>` : ''}
                    </td>
                    <td class="p-5 text-center px-2 flex justify-center gap-2">
                         <button onclick="editCustomer(${c.id})" class="text-slate-500 hover:text-indigo-400 transition-colors" title="Edit">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                         </button>
                         <button onclick="deleteCustomer(${c.id})" class="text-slate-500 hover:text-rose-400 transition-colors" title="Hapus">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                         </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function openCustomerModal(editId = null) {
            document.getElementById('customerForm').reset();
            document.getElementById('custId').value = '';

            if (editId) {
                const c = customers.find(c => c.id === editId);
                if (c) {
                    document.getElementById('custId').value = c.id;
                    document.getElementById('custName').value = c.name;
                    document.getElementById('custAddress').value = c.address;
                    document.getElementById('custWA').value = c.wa;
                    document.getElementById('custTele').value = c.tele;
                }
            }

            document.getElementById('customerModal').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('customerModalContent').classList.remove('scale-95', 'opacity-0');
                document.getElementById('customerModalContent').classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function editCustomer(id) {
            openCustomerModal(id);
        }

        function deleteCustomer(id) {
            if (confirm('Hapus pelanggan ini?')) {
                customers = customers.filter(c => c.id !== id);
                saveData();
                renderCustomers();
            }
        }

        function closeCustomerModal() {
            document.getElementById('customerModalContent').classList.add('scale-95', 'opacity-0');
            document.getElementById('customerModalContent').classList.remove('scale-100', 'opacity-100');
            setTimeout(() => {
                document.getElementById('customerModal').classList.add('hidden');
            }, 300);
        }

        document.getElementById('customerForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('custId').value;
            const name = document.getElementById('custName').value;
            const address = document.getElementById('custAddress').value;
            const wa = document.getElementById('custWA').value;
            const tele = document.getElementById('custTele').value;

            if (id) {
                const index = customers.findIndex(c => c.id == id);
                if (index !== -1) customers[index] = { ...customers[index], name, address, wa, tele };
            } else {
                customers.push({ id: Date.now(), name, address, wa, tele });
            }

            saveData();
            renderCustomers();
            closeCustomerModal();
        });

        // --- DASHBOARD & CHARTS ---
        function updateDashboard() {
            if (!salesChart) initChart(); // Ensure chart is initialized if not already

            let totalSales = 0;
            let totalCost = 0;
            let totalProfit = 0;
            let todayProfit = 0;

            const currentMonth = dayjs().month();
            const today = dayjs().format('YYYY-MM-DD');

            transactions.forEach(t => {
                if (t.type === 'sell' && dayjs(t.date).month() === currentMonth) {
                    totalSales += t.total;
                    totalCost += (t.totalCost || 0); // Handle legacy
                    totalProfit += (t.profit || 0);
                }

                if (dayjs(t.date).format('YYYY-MM-DD') === today) {
                    todayProfit += (t.profit || 0);
                }
            });

            document.getElementById('monthlySales').innerText = formatRupiah(totalSales);
            document.getElementById('monthlyCost').innerText = formatRupiah(totalCost);
            document.getElementById('monthlyProfit').innerText = formatRupiah(totalProfit);
            document.getElementById('todayProfit').innerText = formatRupiah(todayProfit);

            updateChart();
        }

        function initChart() {
            const ctx = document.getElementById('salesChart').getContext('2d');

            // Gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(16, 185, 129, 0.5)'); // Emerald
            gradient.addColorStop(1, 'rgba(16, 185, 129, 0.0)');

            salesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Profit Bersih',
                        data: [],
                        borderColor: '#10b981',
                        backgroundColor: gradient,
                        borderWidth: 2,
                        pointBackgroundColor: '#ffffff',
                        pointBorderColor: '#10b981',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#1e293b',
                            titleColor: '#f8fafc',
                            bodyColor: '#cbd5e1',
                            borderColor: '#334155',
                            borderWidth: 1,
                            padding: 10
                        }
                    },
                    scales: {
                        y: {
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { color: '#64748b' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#64748b' }
                        }
                    }
                }
            });
        }

        function updateChart() {
            if (!salesChart) return;

            // Get last 7 days keys
            const labels = [];
            const dataMap = {};
            for (let i = 6; i >= 0; i--) {
                const date = dayjs().subtract(i, 'day').format('YYYY-MM-DD');
                labels.push(dayjs(date).format('DD MMM'));
                dataMap[date] = 0;
            }

            // Fill Data
            transactions.forEach(t => {
                const dateKey = dayjs(t.date).format('YYYY-MM-DD');
                if (dataMap.hasOwnProperty(dateKey)) {
                    dataMap[dateKey] += (t.profit || 0);
                }
            });

            salesChart.data.labels = labels;
            salesChart.data.datasets[0].data = Object.values(dataMap);
            salesChart.update();
        }

        // --- UTILS ---
        function saveData() {
            localStorage.setItem('cindolab_inventory', JSON.stringify(inventory));
            localStorage.setItem('cindolab_transactions', JSON.stringify(transactions));
            localStorage.setItem('cindolab_customers', JSON.stringify(customers)); // New
        }

        function formatRupiah(number) {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(number);
        }

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({ inventory, transactions }));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "backup_cindolab_pos.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }
    </script>
</body>

</html>